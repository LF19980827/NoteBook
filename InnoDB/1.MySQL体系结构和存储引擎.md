# MySQL体系结构和存储引擎

------

[TOC]

-------

## 1. 定义数据库和实例

数据库领域中"数据库"和"实例"的概念如下:

-   数据库:物理操作系统文件或其他形式文件类型的集合.
-   实例:MySQL数据库有后台线程以及一个共享内存区组成.


​		我们通常意义上讲的数据库实际上是实例,而数据库在本地磁盘上存储的数据文件才是真正意义上的数据库.

​		**MySQL数据库实例在系统上的表现就是一个进程.**

​		当MySQL数据库实例启动时,会现在某些默认的位置查找配置文件,可以通过以下指令查询这些位置.查询出的位置有多个,MySQL会以最后一个位置中的配置为准.

```shell
mysql --help | grep my.cnf
```

​		配置文件中有一个参数datadir,指定了数据库所在的路径,但是这个路径只是一个链接,指向了/opt/mysql_data目录,用户必须保证该目录的用户和权限只有mysql用户和组可以访问.

## 2. MySQL体系结构

MySQL由以下几部分构成:

-   连接池组件
-   管理服务和工具组件
-   SQL接口组件
-   查询分析器组件
-   优化器组件
-   缓冲(Cache)组件
-   插件式存储引擎
-   物理文件

​		MySQL数据库区别于其他数据库的最重要的一个特点就是其插件式的存储引擎.MySQL插件式的存储引擎架构提供了一系列标准的管理和服务支持,这些标准与存储引擎本身无关,可能是每个数据库系统本身必须的,而存储引擎是底层物理结构的实现,可根据开发者的意愿进行开发.

​		需要特别注意的是,存储引擎是基于表的,而不是数据库.

## 3. MySQL存储引擎

​		存储引擎的好处是,每个存储引擎都有各自的特点,能够根据具体的应用建立不同的存储引擎表.

​		由于MySQL数据库开源的特性,存储引擎可以分为MySQL官方存储引擎和第三方存储引擎,如InnoDB.

### (1). InnoDB存储引擎

​		InnoDB存储引擎支持事务,其设计主要面向联机事务处理(OLTP)的应用.特点是行锁设计,支持外键,并且支持类似于Oracle的非锁定读,也就是默认读取操作不会产生锁.

​		InnoDB存储引擎将数据放在一个逻辑的表空间中,像黑盒一样由InnoDB存储引擎自身进行管理.

​		InnoDB通过多版本并发控制来获得高并发性,并且实现了SQL标准的4中隔离级别,默认为REPEATABLE.

SQL的四种隔离级别:

1.  READ UNCOMMITED(未提交读):事务可以读取未提交的数据，这也称为脏读（Dirty Read）。
1.  READ COMMITED (提交读):一个事务从开始到提交之前，所做的任何修改对其他事务都是不可见的。在同一事务中，多次读取同一数据但是返回不同的结果，也就是有其他事务更改了这些数据。
1.  REPEATABLE READ (可重复读):该级别保证了在同一个事务中多次读取同样的记录的结果是一致的。无法解决另一个幻读 （PhantomRead）的问题。就是说在第一个事务开始时，读取到一批数据，但是伺候另一个事务又插入新数据并提交，此时第一个事务又读取到这批数据但是发现多出了一条,貌似产生幻觉一样。
1.  SERIALIZABLE(可串行化):它通过强制事务串行，避免了前面说的幻读问题。

​		使用一种被称为next-key locking的策略来避免幻读现象的产生.初次之外,InnoDB存储引擎还提供了插入缓存,二次写,自适应哈希索引,预读等高性能和高可用的功能.

​		InnoDB存储引擎采用了聚集的方式,因此每张表的存储都是按主键顺序进行存放.如果没有显示的定义主键,InnoDB会给每一行生成一个6字节的ROWID,以此为主键.

### (2). MyISAM存储引擎

​		MyISAM存储引擎不支持事务,表锁设计,支持全文索引,主要面向一些联机分析处理(OLAP)数据库应用.

​		MyISAM存储引擎的缓冲池只缓存索引文件,不缓冲数据文件.

​		MyISAM存储引擎表有MYD和MYI组成,MYD用来存放数据文件,MYI用来存放索引文件.

### (3). NDB存储引擎

​		NDB存储引擎是一个集群存储引擎,其结构是share nothing的集群架构,因此能提供更高的可用性.

​		NDB存储引擎的链接操作是在MySQL数据库层完成的,而不是在存储引擎层完成的,这意味这需要巨大的网络开销,查询速度慢.

### (4). Memory存储引擎

​		Memory存储引擎将表中的数据放在内存中,默认使用哈希索引.速度较快,但是只支持表锁,并发性较差,且存储变长字段时是按照定长字段的方式进行的,会浪费内存.

### (5). Archive存储引擎

​		Archive存储引擎只支持inster和select操作,使用zlib算法将数据航进行压缩后存储,非常适合存储贵方数据.使用行锁来实现高并发的插入操作,但是本身并不是事务安全的.

### (6). Federated存储引擎

​		Federated存储引擎表并不存放数据,指向一台远程MySQL数据库服务器上的表.

### (7). Maria存储引擎

​		Maria存储引擎可以被看做是MyISAM的后续版本.支持缓存数据和索引文件,应用了行锁设计,提供了MVCC功能,支持事务和非事务安全的选项,以及更好的BLOB字符类型的处理性能.

## 4. 连接MySQL

​		连接MySQL的操作是一个连接进程和MySQL数据库实例进行通信,本质上是进程间的通信.常用的进程通信方式有管道,命名管道,命名字,TCP/IP套接字,UNIX域套接字.

### (1). TCP/IP

​		TCP/IP套接字方式是MySQL数据库在任何平台下都提供的连接方式.这种方式在TCP/IP连接上建立一个基于网络的连接请求,一般情况下客户端在一台服务器上,MySQL实例在另外一台服务器上,两台机器通过一个TCP/IP网络连接.

​		下面这个命令就可以通过TCP/IP方式进行MySQL的远端连接:

```shell
mysql -h xxx.xxx.xxx.xxx -u username -p password;
```

​		在通过TCP/IP连接到MySQL实例时,MySQL会先检查一张权限视图,也就是mysql.user这张表.只有拥有权限的用户+机器才可以对数据库进行修改.

### (2). 命名管道和共享内存

​		两个需要进程通信的进程在同一台服务器上,使用命名管道.

​		MySQL也提供了共享内存的链接方式.

### (3). UNIX域套接字

​		由于UNIX域套接字不是网络协议,所以只能在MySQL客户端和数据库实例在一台服务器上的情况下使用.